---
name: Build & Release
on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
env:
  SETTINGS_XML: ${{ github.workspace }}/.mvn/settings.xml
  JAVA_VERSION: 17
  JAVA_DISTRIBUTION: temurin
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    env:
      IO_JFROG_SBB_POLARION_TOKEN: ${{ secrets.IO_JFROG_SBB_POLARION_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      MARKDOWN2HTML_MAVEN_PLUGIN_FAIL_ON_ERROR: true
    steps:
      - name: ðŸ“„ Checkout the repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: ðŸ§± Set up JDK and Maven with cache
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00  # v4.7.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - name: ðŸ“ Extract project metadata and build
        id: project_metadata
        run: |
          # Build and extract version in one go
          mvn --batch-mode -s "${SETTINGS_XML}" clean package
          # Extract version from pom.xml without running Maven again
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          # Check if it is a release
          if [[ ! "${VERSION}" =~ -SNAPSHOT$ ]]; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
          fi
      - name: ðŸ“¦ Build with Maven for Pushes
        if: github.event_name == 'push'
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: mvn --batch-mode -s "${SETTINGS_XML}" clean package  # sonar:sonar -Dsonar.branch.name="${GITHUB_HEAD_REF}"
      - name: ðŸ“¦ Build with Maven for PRs
        if: github.event_name == 'pull_request'
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_PR_NUMBER_REF: ${{ github.event.pull_request.number }}
        run: mvn --batch-mode -s "${SETTINGS_XML}" clean package  # sonar:sonar -Dsonar.pullrequest.base="${GITHUB_HEAD_REF}" -Dsonar.pullrequest.branch="${GITHUB_BASE_REF}" -Dsonar.pullrequest.key="${GITHUB_PR_NUMBER_REF}"
      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: maven-artifacts
          path: |
            target/*.jar
            pom.xml
            .mvn/
          retention-days: 1
    outputs:
      project_version: ${{ steps.project_metadata.outputs.version }}
      is_release: ${{ steps.project_metadata.outputs.is_release }}

  # Deploy jobs run in parallel
  deploy-maven-central:
    needs: build
    if: ${{ needs.build.outputs.is_release == 'true' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    env:
      IO_JFROG_SBB_POLARION_TOKEN: ${{ secrets.IO_JFROG_SBB_POLARION_TOKEN }}
      COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_USERNAME: ${{ secrets.COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_USERNAME }}
      COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_TOKEN: ${{ secrets.COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_TOKEN }}
      COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_GPG_PASSPHRASE: ${{ secrets.COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_GPG_PASSPHRASE }}
    steps:
      - name: ðŸ§± Set up JDK and Maven with cache
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00  # v4.7.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.7
        with:
          name: maven-artifacts
      - name: ðŸ“¦ Deploy to Maven Central
        run: |
          # Skip compilation since we are using pre-built artifacts
          mvn --batch-mode -s "${SETTINGS_XML}" deploy \
            -Dmaven.test.skip=true \
            -Dmaven.main.skip=true \
            -Dmaven.jar.attach=false \
            -P gpg-sign \
            -P central-publishing \
            -Dcentral-publishing-maven-plugin.autoPublish=false
  deploy-github-packages:
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      IO_JFROG_SBB_POLARION_TOKEN: ${{ secrets.IO_JFROG_SBB_POLARION_TOKEN }}
      GITHUB_TOKEN: ${{ github.token }}
      GITHUB_REPO_NAME: ${{ github.repository }}
    steps:
      - name: ðŸ§± Set up JDK and Maven with cache
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00  # v4.7.1
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.7
        with:
          name: maven-artifacts
      - name: ðŸ“¦ Deploy to GitHub Packages
        run: |
          # Skip compilation since we are using pre-built artifacts
          mvn --batch-mode -s "${SETTINGS_XML}" deploy \
            -Dmaven.test.skip=true \
            -Dmaven.main.skip=true \
            -Dmaven.jar.attach=false \
            -Dmaven.javadoc.skip=true \
            -Dmaven.source.skip=true \
            -P deploy-github-packages
      - name: ðŸ“¦ Upload assets to GitHub Release
        if: ${{ needs.build.outputs.is_release == 'true' }}
        env:
          RELEASE_VERSION: ${{ needs.build.outputs.project_version }}
        run: |-
          gh release upload "v${RELEASE_VERSION}" "target/*-${RELEASE_VERSION}.jar" --clobber
